# -*- coding: utf-8 -*-
"""app2.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1KPHODW39oyJqMIqEkt0qrUaFijFqbZdJ
"""

import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go


# =====================
# CONFIGURA√á√ÉO DA P√ÅGINA
# =====================
st.set_page_config(layout="wide")

st.markdown("""
<h1 style='margin-bottom:0;'>Performance de An√∫ncios</h1>
<h4 style='color:#6c757d; margin-top:5px;'>Corretor Gramado & Canela</h4>
<hr>
""", unsafe_allow_html=True)

# =====================
# ESTADO DA APLICA√á√ÉO
# =====================
if "visao" not in st.session_state:
    st.session_state.visao = None

# =====================
# UPLOAD DO ARQUIVO
# =====================
uploaded_file = st.file_uploader("üì§ Upload do Excel", type=["xlsx"])

if uploaded_file is None:
    st.info("‚¨Ü Envie o arquivo Excel para come√ßar")
    st.stop()

# =====================
# LEITURA DO EXCEL
# =====================
df = pd.read_excel(uploaded_file)

# =====================
# VALIDA√á√ÉO M√çNIMA
# =====================
colunas_esperadas = [
    'CEP',
    'Cria√ß√£o',
    '√öltima atualiza√ß√£o',
    'Total de visualiza√ß√µes',
    'Total de contatos',
    'Tipo do an√∫ncio'
]

for c in colunas_esperadas:
    if c not in df.columns:
        st.error(f"Coluna faltando: {c}")
        st.stop()

# =====================
# TRATAMENTO DE DADOS
# =====================
df['CEP'] = df['CEP'].astype(str).str.zfill(8)
df['Cria√ß√£o'] = pd.to_datetime(df['Cria√ß√£o'], errors='coerce', dayfirst=True)
df['√öltima atualiza√ß√£o'] = pd.to_datetime(df['√öltima atualiza√ß√£o'], errors='coerce', dayfirst=True)

df['taxa_convers√£o'] = np.where(
    df['Total de visualiza√ß√µes'] > 0,
    (df['Total de contatos'] / df['Total de visualiza√ß√µes']) * 100,
    0
)

# =====================
# GAUGE ‚Äî TAXA DE CONVERS√ÉO GERAL (R√ÅPIDO)
# =====================
total_visualizacoes = df['Total de visualiza√ß√µes'].sum()
total_contatos = df['Total de contatos'].sum()

taxa_conversao_geral = (
    (total_contatos / total_visualizacoes) * 100
    if total_visualizacoes > 0 else 0
)

fig_gauge = go.Figure(go.Indicator(
    mode="gauge+number",
    value=taxa_conversao_geral,
    number={"suffix": "%", "valueformat": ".2f"},
    title={"text": "Taxa de Convers√£o Geral"},
    gauge={
        "axis": {"range": [0, 2]},
        "bar": {"color": "black"},  # barra neutra leve
        "steps": [
            {"range": [0, 0.8], "color": "#dc3545"},
            {"range": [0.8, 1.5], "color": "#ffc107"},
            {"range": [1.5, 2.0], "color": "#198754"},
        ],
        "threshold": {
            "line": {"color": "black", "width": 5},
            "thickness": 0.85,
            "value": taxa_conversao_geral
        }
    }
))

st.plotly_chart(fig_gauge, use_container_width=True)


# =====================
# BASE GLOBAL
# =====================
base = df.copy()

# =====================
# KPIs PRINCIPAIS
# =====================
total_visualizacoes = base['Total de visualiza√ß√µes'].sum()
total_contatos = base['Total de contatos'].sum()
aluguel = base['Valor do aluguel'].count()

m1, k1, k2, k3, k4, m2 = st.columns([2, 2, 2, 2, 2, 1])

k1.metric("Visualiza√ß√µes", f"{total_visualizacoes:,}".replace(",", "."))
k2.metric("Contatos", f"{total_contatos:,}".replace(",", "."))
k3.metric("An√∫ncios Ativos", len(base))
k4.metric("Alugu√©is", f"{aluguel:,}".replace(",", "."))

# =====================
# SEGMENTA√á√ÉO
# =====================
premium = base[base['Tipo do an√∫ncio'] == 'Destaque Premium']
destaque = base[base['Tipo do an√∫ncio'] == 'Destaque']
padrao = base[base['Tipo do an√∫ncio'] == 'Padr√£o']

padrao_super = padrao[padrao['taxa_convers√£o'] >= 10]
padrao_destaque = padrao[(padrao['taxa_convers√£o'] >= 3) & (padrao['taxa_convers√£o'] < 10)]
padrao_geral = padrao[padrao['taxa_convers√£o'] < 3]

# =====================
# FUN√á√ÉO DE CARD (SAFE)
# =====================
def card(label, value, key, icon="üì¶"):
    with st.container(border=True):
        st.markdown(
            f"""
            <div style="text-align:center;">
                <div style="font-size:28px;">{icon}</div>
                <div style="font-size:14px; color:#6c757d;">{label}</div>
                <div style="font-size:32px; font-weight:700;">{value}</div>
            </div>
            """,
            unsafe_allow_html=True
        )
        return st.button("Ver detalhes", key=key, use_container_width=True)

# =====================
# DESTAQUE PREMIUM
# =====================
st.subheader("An√∫ncios ‚Äî Destaque Premium")
p1, p2, p3 = st.columns(3)

with p1:
    if card("Todos os An√∫ncios", len(premium), "premium_total"):
        st.session_state.visao = "premium_total"

with p2:
    if card("Receberam Mensagem", len(premium[premium['Total de contatos'] > 0]), "premium_com", "‚úÖ"):
        st.session_state.visao = "premium_com"

with p3:
    if card("N√£o Receberam Mensagem", len(premium[premium['Total de contatos'] == 0]), "premium_sem", "‚ùå"):
        st.session_state.visao = "premium_sem"

# =====================
# DESTAQUE
# =====================
st.subheader("An√∫ncios ‚Äî Destaque")
d1, d2, d3 = st.columns(3)

with d1:
    if card("Todos os An√∫ncios", len(destaque), "destaque_total"):
        st.session_state.visao = "destaque_total"

with d2:
    if card("Receberam Mensagem", len(destaque[destaque['Total de contatos'] > 0]), "destaque_com", "‚úÖ"):
        st.session_state.visao = "destaque_com"

with d3:
    if card("N√£o Receberam Mensagem", len(destaque[destaque['Total de contatos'] == 0]), "destaque_sem", "‚ùå"):
        st.session_state.visao = "destaque_sem"

# =====================
# PADR√ÉO ‚Äî GERAL
# =====================
st.subheader("An√∫ncios ‚Äî Padr√£o (Geral)")
g1, g2, g3 = st.columns(3)

with g1:
    if card("Todos os An√∫ncios", len(padrao_geral), "padrao_total"):
        st.session_state.visao = "padrao_total"

with g2:
    if card("Receberam Mensagem", len(padrao_geral[padrao_geral['Total de contatos'] > 0]), "padrao_com", "‚úÖ"):
        st.session_state.visao = "padrao_com"

with g3:
    if card("N√£o Receberam Mensagem", len(padrao_geral[padrao_geral['Total de contatos'] == 0]), "padrao_sem", "‚ùå"):
        st.session_state.visao = "padrao_sem"

# =====================
# PADR√ÉO ‚Äî DESTAQUES
# =====================

r1, r2 = st.columns(2)

with r1:
    if card("Converteram mais de 10% das visualiza√ß√µes", len(padrao_super), "padrao_super", "üî•"):
        st.session_state.visao = "padrao_super"

with r2:
    if card("Converteram entre 3% e 10% das visualiza√ß√µes", len(padrao_destaque), "padrao_destaque", "üìà"):
        st.session_state.visao = "padrao_destaque"

st.divider()

# =====================
# EXIBI√á√ÉO DA TABELA
# =====================

def estilo_taxa_conversao(val):
    if val < 0.6:
        return "color: red; font-weight: bold;"
    elif 0.6 <= val <= 1:
        return "color: orange; font-weight: bold;"
    else:
        return "color: green; font-weight: bold;"


def estilo_visualizacoes(val, tipo):
    limites = {
        "Destaque Premium": 300,
        "Destaque": 200,
        "Padr√£o": 100
    }
    limite = limites.get(tipo, 0)
    if val < limite:
        return "color: red; font-weight: bold;"
    else:
        return "color: orange; font-weight: bold;"


mapa = {
    "premium_total": premium,
    "premium_com": premium[premium['Total de contatos'] > 0],
    "premium_sem": premium[premium['Total de contatos'] == 0],

    "destaque_total": destaque,
    "destaque_com": destaque[destaque['Total de contatos'] > 0],
    "destaque_sem": destaque[destaque['Total de contatos'] == 0],

    "padrao_total": padrao_geral,
    "padrao_com": padrao_geral[padrao_geral['Total de contatos'] > 0],
    "padrao_sem": padrao_geral[padrao_geral['Total de contatos'] == 0],

    "padrao_super": padrao_super,
    "padrao_destaque": padrao_destaque,
}

colunas_exibicao = [
    'C√≥digo do Im√≥vel',
    'Tipo do an√∫ncio',
    'Bairro',
    'Cidade',
    'Valor de Venda',
    'Valor do aluguel',
    'N√∫mero de fotos',
    'V√≠deo',
    'Total de visualiza√ß√µes',
    'Total de contatos',
    '√öltima atualiza√ß√£o',
    'taxa_convers√£o'
]


def formato_moeda(valor):
    if pd.isna(valor):
        return ""
    return f"R$ {valor:,.2f}".replace(",", "X").replace(".", ",").replace("X", ".")


def formato_percentual(valor):
    if pd.isna(valor):
        return ""
    return f"{valor:.2f}%"

if st.session_state.visao in mapa:
    st.subheader("üìã Detalhamento")

    tabela = mapa[st.session_state.visao].copy()

    # mant√©m somente as colunas desejadas
    tabela = tabela[colunas_exibicao]

    recebeu_contato = tabela['Total de contatos'].sum() > 0

    if recebeu_contato:
        # üîπ Tabelas que receberam contato
        tabela = tabela.sort_values(by='taxa_convers√£o', ascending=False)

        st.dataframe(
            tabela.style
            .format({
                'Valor de Venda': formato_moeda,
                'Valor do aluguel': formato_moeda,
                'taxa_convers√£o': formato_percentual
            })
            .applymap(
                estilo_taxa_conversao,
                subset=['taxa_convers√£o']
            ),
            use_container_width=True,
            hide_index=True
        )

    else:
        # üîπ Tabelas que N√ÉO receberam contato
        tabela = tabela.sort_values(by='Total de visualiza√ß√µes', ascending=False)

        st.dataframe(
            tabela.style
            .format({
                'Valor de Venda': formato_moeda,
                'Valor do aluguel': formato_moeda,
                'taxa_convers√£o': formato_percentual
            })
            .apply(
                lambda row: [
                    estilo_visualizacoes(row['Total de visualiza√ß√µes'], row['Tipo do an√∫ncio'])
                    if col == 'Total de visualiza√ß√µes' else ""
                    for col in tabela.columns
                ],
                axis=1
            ),
            use_container_width=True,
            hide_index=True
        )